(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const u of n.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function o(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(s){if(s.ep)return;s.ep=!0;const n=o(s);fetch(s.href,n)}})();const R=`
<header>
  <a href="https://greenstem.uk/demo">GreenStem.uk</a>
</header>

<main>
  <h1>Convert text to speech</h1>
  <p><label for="ron_text">Enter text:</label></p>
  <textarea name="ron_text" id="ron_text" rows="20" cols="33"
    placeholder="Enter text here"></textarea>
  <div class="button-group">
    <button id="process_text_button" type="button" disabled>Create Speech</button>
    <button id="clear_button" type="button" disabled>Clear Text</button>
    <button id="halt_button" type="button" disabled>Halt Processing</button>
  </div>
  <audio id="audio_output" controls
    style="opacity: 0.4; transition: opacity 0.2s ease-in-out;">
  </audio>
  <p id="status_report">Downloading artificial neural network</p>
  <progress id="progress_bar" max="100" value="0"
    style="opacity: 0; transition: opacity 0.2s ease-in-out; width: 100%;">
  </progress>
</main>

<footer>
  <h2>How it works</h2>
  <p>
    This web app uses advanced machine-learning running right in your browser to
    convert text into natural-sounding speech. Your text stays private on your device.
  </p>
  <p>
    Powered by <a href="https://huggingface.co/docs/transformers.js/index" target="_blank"
      rel="noopener noreferrer">Transformers.js</a>
    and <a href="https://huggingface.co/Xenova/speecht5_tts" target="_blank"
      rel="noopener noreferrer">Xenova</a>.
  </p>
  <p>
    Ron Reade project on <a href="https://github.com/martinmphil/ron_reade" target="_blank"
      rel="noopener noreferrer">GitHub</a>
  </p>
</footer>
`,T={audioLifecycle:"modelLoading",modelLoadRetryCount:0,processingRetryCount:0,errorMessage:null,processingProgress:0,processingTotal:0,lastProcessedText:null,loadingDots:0},h=7;function m(e,t){switch(t.type){case"UPDATE_LOADING_DOTS":return e.audioLifecycle==="modelLoading"?{...e,loadingDots:e.loadingDots>=6?0:e.loadingDots+1}:e;case"USER_INPUT_TEXT":return{...e,audioLifecycle:"idle"};case"USER_CLEARED_TEXT":return e;case"PROCESS_TEXT_SUBMITTED":return e.audioLifecycle==="idle"||e.audioLifecycle==="paused"||e.audioLifecycle==="readyToPlay"?{...e,audioLifecycle:"processing",processingRetryCount:0,errorMessage:null,processingProgress:0,processingTotal:t.payload.totalChunks}:e;case"PROCESSING_CHUNK_SUCCESS":return{...e,processingProgress:e.processingProgress+1};case"MODEL_LOAD_SUCCESS":return{...e,audioLifecycle:"idle",modelLoadRetryCount:0,loadingDots:0};case"MODEL_LOAD_FAILURE":const o=e.modelLoadRetryCount+1;return o>=h?{...e,audioLifecycle:"error",errorMessage:"Failed to load the AI model after several retries. Please reload the page.",loadingDots:0}:{...e,modelLoadRetryCount:o};case"PROCESSING_SUCCESS":return{...e,audioLifecycle:"readyToPlay",processingRetryCount:0,lastProcessedText:t.payload};case"PROCESSING_FAILURE":const r=e.processingRetryCount+1;return r>=h?{...e,audioLifecycle:"error",errorMessage:t.payload}:{...e,processingRetryCount:r,errorMessage:t.payload};case"USER_HALTED_PROCESSING":return{...e,audioLifecycle:"modelLoading",modelLoadRetryCount:0,processingRetryCount:0,errorMessage:null,processingProgress:0,processingTotal:0,loadingDots:0};case"USER_PLAYED_AUDIO":return{...e,audioLifecycle:"playing"};case"USER_PAUSED_AUDIO":return{...e,audioLifecycle:"paused"};case"AUDIO_PLAYBACK_ENDED":return{...e,audioLifecycle:"idle"};default:return e}}function P(e){return".".repeat(e)}function _(e,t){const{audioLifecycle:o,errorMessage:r,processingProgress:s,processingTotal:n,lastProcessedText:u}=t,p=e.ronText.value.trim(),f=p.length>0&&p!==u&&(o==="idle"||o==="paused"||o==="readyToPlay");e.processTextButton.disabled=!f,e.haltButton.disabled=o!=="processing",e.clearButton.disabled=e.ronText.value.trim().length===0;const a=o==="readyToPlay"||o==="playing"||o==="paused";e.audioOutput.style.opacity=a?"1":"0.4";const l=o==="processing";switch(e.progressBar.style.opacity=l?"1":"0",l&&(e.progressBar.max=n+1,e.progressBar.value=s+1),o!=="modelLoading"&&e.statusReport.classList.remove("loading"),o){case"modelLoading":e.statusReport.textContent="Downloading artificial neural network",e.statusReport.classList.add("loading"),e.statusReport.style.setProperty("--loading-dots",`"${P(t.loadingDots)}"`);break;case"idle":e.statusReport.textContent=e.ronText.value.trim().length>0?"Ready to convert your text into speech.":"Please enter text to be read aloud.";break;case"processing":e.statusReport.textContent=`Processing chunk ${s+1} of ${n}...`;break;case"readyToPlay":e.statusReport.textContent="Please press the play button on the audio player.";break;case"playing":e.statusReport.textContent="Playback in progress...";break;case"paused":e.statusReport.textContent=e.ronText.value.trim().length>0?"Playback paused. Ready to process new text.":"Playback paused.";break;case"error":e.statusReport.textContent=r||"An unknown error occurred.";break;default:e.statusReport.textContent=""}}let c=null;function S(){c&&c.terminate(),c=new Worker(new URL("/demo/ron-reade/assets/voicing.worker-DtmNr0oi.js",import.meta.url),{type:"module"})}function x(){return new Promise((e,t)=>{if(!c)return t("Voicing service not initialized.");c.onmessage=o=>{o.data.type==="modelLoadSuccess"?e():o.data.type==="processingFailure"&&t(o.data.payload)},c.postMessage({type:"loadModel"})})}function U(e){return new Promise((t,o)=>{if(!c)return o("Voicing service not initialized.");c.onmessage=r=>{r.data.type==="processingSuccess"?t(r.data.payload):r.data.type==="processingFailure"&&o(r.data.payload)},c.postMessage({type:"processText",payload:e})})}const E=400;function A(e){const t=e.trim();if(!t)return[];const o=[];let r=t;for(;r.length>0;){let n=r.substring(0,E).indexOf(".");n!==-1?n+=1:r.length>E?n=E:n=r.length;const u=r.substring(0,n).trim();u&&o.push(u),r=r.substring(n).trim()}return o}function D(e,t){const p=t*4,d=e.length*4,g=36+d,f=new ArrayBuffer(44+d),a=new DataView(f);y(a,0,"RIFF"),a.setUint32(4,g,!0),y(a,8,"WAVE"),y(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,3,!0),a.setUint16(22,1,!0),a.setUint32(24,t,!0),a.setUint32(28,p,!0),a.setUint16(32,4,!0),a.setUint16(34,32,!0),y(a,36,"data"),a.setUint32(40,d,!0);for(let l=0;l<e.length;l++)a.setFloat32(44+l*4,e[l],!0);return new Blob([a],{type:"audio/wav"})}function y(e,t,o){for(let r=0;r<o.length;r++)e.setUint8(t+r,o.charCodeAt(r))}const O=16e3;document.querySelector("#app").innerHTML=R;const i={state:T};document.addEventListener("DOMContentLoaded",b);window.addEventListener("pageshow",e=>{e.persisted&&b()});function b(){const e={ronText:document.getElementById("ron_text"),processTextButton:document.getElementById("process_text_button"),clearButton:document.getElementById("clear_button"),haltButton:document.getElementById("halt_button"),audioOutput:document.getElementById("audio_output"),progressBar:document.getElementById("progress_bar"),statusReport:document.getElementById("status_report")},t=o=>{const r=m(i.state,o);r!==i.state&&(i.state=r,_(e,i.state))};w(e,t),_(e,i.state),L(t)}function w(e,t){e.ronText.addEventListener("input",()=>{t({type:"USER_INPUT_TEXT"})}),e.clearButton.addEventListener("click",()=>{e.ronText.value="",t({type:"USER_CLEARED_TEXT"})}),e.processTextButton.addEventListener("click",()=>{C(t,e,e.ronText.value)}),e.haltButton.addEventListener("click",()=>{S(),t({type:"USER_HALTED_PROCESSING"}),L(t)}),e.audioOutput.addEventListener("pause",()=>{e.audioOutput.ended?t({type:"AUDIO_PLAYBACK_ENDED"}):t({type:"USER_PAUSED_AUDIO"})}),e.audioOutput.addEventListener("play",()=>{t({type:"USER_PLAYED_AUDIO"})})}async function L(e){const t=setInterval(()=>{e({type:"UPDATE_LOADING_DOTS"})},1e3);S();try{await x(),clearInterval(t),e({type:"MODEL_LOAD_SUCCESS"})}catch(o){console.error("Failed to load model:",o),e({type:"MODEL_LOAD_FAILURE"}),i.state.audioLifecycle==="modelLoading"?setTimeout(()=>L(e),2e3*i.state.modelLoadRetryCount):clearInterval(t)}}async function C(e,t,o){if(i.state.audioLifecycle!=="idle"&&i.state.audioLifecycle!=="paused"&&i.state.audioLifecycle!=="readyToPlay")return;let r=new Float32Array(0);const s=A(o);if(s.length!==0){e({type:"PROCESS_TEXT_SUBMITTED",payload:{totalChunks:s.length}});try{for(const p of s){const d=await U(p);e({type:"PROCESSING_CHUNK_SUCCESS"});const g=new Float32Array(r.length+d.length);g.set(r,0),g.set(d,r.length),r=g}const n=D(r,O),u=URL.createObjectURL(n);t.audioOutput.src=u,e({type:"PROCESSING_SUCCESS",payload:o})}catch(n){console.error("Failed to process text:",n),e({type:"PROCESSING_FAILURE",payload:n.message}),i.state.audioLifecycle==="processing"&&setTimeout(()=>C(e,t,o),2e3*i.state.processingRetryCount)}}}
